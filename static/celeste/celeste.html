<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8" />
  	<title>celeste</title>
	<meta name="description" content=""/>
	<meta name="keywords" content=""/>
    <link type="text/css" rel="stylesheet" href="/static/css/main.css" />
    <script type="text/javascript" src="/static/js/jquery.notmin.js"></script>
    <script type="text/javascript" src="/static/js/util.js"></script>
    <script type="text/javascript" src="/static/js/objects.js"></script>
    <script type="text/javascript" src="/static/js/astro.js"></script>
    <script type="text/javascript" src="/static/js/celeste.js"></script>
<script type="text/javascript">	
	$(function(){//onReady
		_viewer = new Viewer(new Canvas($('#canvas')[0]));
		if ($.param('al') != '') _viewer.al = parseFloat($.param('al'));
		if ($.param('az') != '') _viewer.az = parseFloat($.param('az')); 
		if ($.param('d') != '') _viewer.d = parseFloat($.param('d')); 
		_keyboard = new Keyboard(_viewer);
		_viewer.notifyListeners();
		$(document).keydown(function(e){
			_keyboard.keyChange(e, true);
			if (debug){
				_keyboard.keyboardResponse();
			}
		}).keyup(function(e){
			_keyboard.keyChange(e, false);
		});
		if (!debug){
			setInterval(keyboardListener, 35);
		}
		drawSunMap(new Date());
	});
	function keyboardListener(){
		_keyboard.keyboardResponse();
	}
	function drawSunMap(date){
		var canvas = $('#sun-map')[0];
		var context = canvas.getContext('2d');
		
		var coord = astro.getGeographicCoordOfSun(date);
		var cLat = degToRad(coord.lat);
		var cLon = degToRad(coord.lon);
		//draw equator
		context.clearRect(0,0,360,180);
		context.strokeStyle = "rgba(0,0,40,0.5)";
		context.moveTo(0, 90);
		context.lineTo(360, 90);
		context.stroke();
		//draw shadow of darkness
		var above = getEdgeOfBrightness(cLon, cLat, cLon) > cLat;
		context.fillStyle = "rgba(0,0,40,0.3)";
		context.moveTo(360, above ? 0 : 180);
		context.lineTo(  0, above ? 0 : 180);
		for (var i = 0; i <= 360; i++){
			var lon = Math.PI * (i - 180) / 180;
			var lat = getEdgeOfBrightness(lon, cLat, cLon);
			var j = 180 * ((Math.PI/2 - lat)/ Math.PI);
			context.lineTo(i, j);
		}
		context.fill();

		context.fillStyle = "#ff0";
		context.strokeStyle = '#ff0';
		context.beginPath();
		context.arc(180 + coord.lon, 90 - coord.lat / Math.PI, 2, 0, Math.PI*2, true);
		context.closePath();
		context.fill();
	}
	function getEdgeOfBrightness(lon, theta, phi){ 
		if (Math.cos(lon - phi) == 0) return 0;
		return -1 * MathExt.sgn(Math.sin(theta) * Math.cos(lon - phi)) * Math.asin(Math.cos(theta) / 
					 Math.sqrt(1 + Math.pow(Math.tan(lon - phi) * Math.sin(theta), 2)));
	}
	function benchmark(fast){
		$.log('beginning benchmark', true); 
		var vec = new Vector(1,2,3);
		var numTrials = 0;
		var totalTime = 0;
		for (var i = 0; i < 10; i++){
			var begin = (new Date()).getTime();
			for (var phi = 0; phi < 2*Math.PI; phi+= 0.01){
				for (var theta = 0; theta < Math.PI/2; theta+=0.01){
					vec = fast ? vec.rotateFast(phi, theta) : vec = vec.rotateZ(phi).rotateY(theta);
				}
			}
			var time  =  (new Date()).getTime() - begin;
			$.log("completed test in " + time + "ms", true);
			totalTime += time;
			numTrials++;
		}
		$.log('avg time = ' + (totalTime/numTrials), true);
	}
</script>
</head>
<body>
<div>
	<div id="canvas-container">
		<canvas id="canvas" width="800" height="500"></canvas>
	</div>
	<div id="model-container">
		<canvas id="sun-map" width="360" height="180"></canvas>
		<div id="time"></div>
		<div>
			az = <span id="model_v_az"></span><br>
			al = <span id="model_v_al"></span><br>
			dist = <span id="model_s_d"></span><br>
		</div>
	</div>
	<div style="clear: both">
	</div>
</div>	
 </body>
</html>
